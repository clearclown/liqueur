# å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªé–‹ç™ºã‚¬ã‚¤ãƒ‰

Project Liquidã‚’ä½¿ç”¨ã—ãŸAIé§†å‹•ã®å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºæŒ‡å—æ›¸

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
5. [å®Ÿè£…æ‰‹é †](#å®Ÿè£…æ‰‹é †)
6. [AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ](#aiãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
8. [ãƒ†ã‚¹ãƒˆ](#ãƒ†ã‚¹ãƒˆ)
9. [ãƒ‡ãƒ—ãƒ­ã‚¤](#ãƒ‡ãƒ—ãƒ­ã‚¤)

---

## æ¦‚è¦

### ã“ã®ã‚¢ãƒ—ãƒªã§å®Ÿç¾ã™ã‚‹ã“ã¨

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç„¶è¨€èªã§å®¶è¨ˆã‚’åˆ†æã§ãã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¾‹**:
- ã€Œä»Šæœˆã®é£Ÿè²»ã‚’å††ã‚°ãƒ©ãƒ•ã§è¦‹ã›ã¦ã€
- ã€Œå…ˆæœˆã¨ä»Šæœˆã®æ”¯å‡ºã‚’æ¯”è¼ƒã—ã¦ã€
- ã€Œã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æ”¯å‡ºæ¨ç§»ã‚’æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã§ã€
- ã€Œä»Šæœˆã®æ”¯å‡ºæ˜ç´°ã‚’æ—¥ä»˜é †ã§è¡¨ç¤ºã€

### Liquidã‚’ä½¿ã†åˆ©ç‚¹

| å¾“æ¥ã®é–‹ç™º | Liquidã‚’ä½¿ã£ãŸé–‹ç™º |
|-----------|------------------|
| å„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å€‹åˆ¥ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° | è‡ªç„¶è¨€èªã‹ã‚‰JSONç”Ÿæˆ |
| UIå¤‰æ›´ã®ãŸã³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º |
| å›ºå®šã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«åˆ†æ |

---

## å‰ææ¡ä»¶

### å¿…è¦ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

```
- Node.js 20+
- PostgreSQL 15+ (ã¾ãŸã¯ MySQL/SQLite)
- Prisma ORM
- Next.js 14+
- React 18+
- AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚­ãƒ¼
```

### æ¨å¥¨é–‹ç™ºç’°å¢ƒ

```bash
# Liquidãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ï¼‰
git clone https://github.com/clearclown/liqueur.git household-budget
cd household-budget

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# Prismaè¿½åŠ 
npm install prisma @prisma/client
npx prisma init
```

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (Next.js)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ãƒãƒ£ãƒƒãƒˆUI  â”‚  â”‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰â”‚  â”‚ å–å¼•å…¥åŠ›    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (Next.js API Routes)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚/api/liquid/ â”‚  â”‚/api/transactionsâ”‚ â”‚/api/auth   â”‚         â”‚
â”‚  â”‚  generate   â”‚  â”‚   CRUD      â”‚  â”‚  JWT        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Liquid Protocol                                            â”‚
â”‚  â€¢ ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼                                              â”‚
â”‚  â€¢ DataSource â†’ Prismaå¤‰æ›                                  â”‚
â”‚  â€¢ Row-Level Securityé©ç”¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database (PostgreSQL)                                      â”‚
â”‚  users, transactions, categories, budgets                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### Prismaã‚¹ã‚­ãƒ¼ãƒ

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼
model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  passwordHash String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  transactions Transaction[]
  categories   Category[]
  budgets      Budget[]
  artifacts    Artifact[]
}

// ã‚«ãƒ†ã‚´ãƒªï¼ˆæ”¯å‡º/åå…¥ã®åˆ†é¡ï¼‰
model Category {
  id        String   @id @default(cuid())
  name      String
  type      CategoryType
  icon      String?
  color     String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  transactions Transaction[]
  budgets      Budget[]

  @@unique([userId, name])
}

enum CategoryType {
  EXPENSE   // æ”¯å‡º
  INCOME    // åå…¥
}

// å–å¼•ï¼ˆæ”¯å‡º/åå…¥ã®è¨˜éŒ²ï¼‰
model Transaction {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(12, 2)
  type        TransactionType
  description String?
  date        DateTime
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, date])
  @@index([userId, categoryId])
}

enum TransactionType {
  EXPENSE   // æ”¯å‡º
  INCOME    // åå…¥
}

// äºˆç®—
model Budget {
  id         String   @id @default(cuid())
  amount     Decimal  @db.Decimal(12, 2)
  month      DateTime // æœˆã®1æ—¥ã‚’æ ¼ç´
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([userId, categoryId, month])
}

// ä¿å­˜ã•ã‚ŒãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆArtifactï¼‰
model Artifact {
  id        String   @id @default(cuid())
  name      String
  schema    Json     // LiquidViewSchema
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### åˆæœŸã‚«ãƒ†ã‚´ãƒªï¼ˆã‚·ãƒ¼ãƒ‰ï¼‰

```typescript
// prisma/seed.ts

const defaultCategories = [
  // æ”¯å‡ºã‚«ãƒ†ã‚´ãƒª
  { name: 'é£Ÿè²»', type: 'EXPENSE', icon: 'ğŸ½ï¸', color: '#FF6384' },
  { name: 'äº¤é€šè²»', type: 'EXPENSE', icon: 'ğŸšƒ', color: '#36A2EB' },
  { name: 'ä½å±…è²»', type: 'EXPENSE', icon: 'ğŸ ', color: '#FFCE56' },
  { name: 'å…‰ç†±è²»', type: 'EXPENSE', icon: 'ğŸ’¡', color: '#4BC0C0' },
  { name: 'é€šä¿¡è²»', type: 'EXPENSE', icon: 'ğŸ“±', color: '#9966FF' },
  { name: 'åŒ»ç™‚è²»', type: 'EXPENSE', icon: 'ğŸ¥', color: '#FF9F40' },
  { name: 'æ•™è‚²è²»', type: 'EXPENSE', icon: 'ğŸ“š', color: '#FF6384' },
  { name: 'å¨¯æ¥½è²»', type: 'EXPENSE', icon: 'ğŸ®', color: '#C9CBCF' },
  { name: 'è¡£æœè²»', type: 'EXPENSE', icon: 'ğŸ‘•', color: '#7C4DFF' },
  { name: 'ãã®ä»–', type: 'EXPENSE', icon: 'ğŸ“¦', color: '#607D8B' },

  // åå…¥ã‚«ãƒ†ã‚´ãƒª
  { name: 'çµ¦ä¸', type: 'INCOME', icon: 'ğŸ’°', color: '#4CAF50' },
  { name: 'å‰¯æ¥­', type: 'INCOME', icon: 'ğŸ’¼', color: '#8BC34A' },
  { name: 'æŠ•è³‡', type: 'INCOME', icon: 'ğŸ“ˆ', color: '#CDDC39' },
  { name: 'ãã®ä»–åå…¥', type: 'INCOME', icon: 'ğŸ’µ', color: '#009688' },
];
```

---

## å®Ÿè£…æ‰‹é †

### Step 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. Liquidãƒ™ãƒ¼ã‚¹ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
git clone https://github.com/clearclown/liqueur.git household-budget
cd household-budget

# 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# 3. PrismaåˆæœŸåŒ–
npm install prisma @prisma/client
npx prisma init

# 4. ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .env
```

```bash
# .env
DATABASE_URL="postgresql://user:password@localhost:5432/household_budget"
AI_PROVIDER=deepseek
DEEPSEEK_API_KEY=sk-your-key
JWT_SECRET=your-jwt-secret
```

### Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# ã‚¹ã‚­ãƒ¼ãƒã‚’prisma/schema.prismaã«è¨˜è¿°å¾Œ
npx prisma migrate dev --name init
npx prisma db seed
```

### Step 3: DatabaseMetadataè¨­å®š

AIãŒãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©ã—ã¾ã™ã€‚

```typescript
// lib/database-metadata.ts

import type { DatabaseMetadata } from '@liqueur/protocol';

export const householdBudgetMetadata: DatabaseMetadata = {
  tables: [
    {
      name: 'transactions',
      description: 'æ”¯å‡ºãƒ»åå…¥ã®å–å¼•è¨˜éŒ²',
      columns: [
        { name: 'id', type: 'string', description: 'å–å¼•ID' },
        { name: 'amount', type: 'decimal', description: 'é‡‘é¡ï¼ˆå††ï¼‰' },
        { name: 'type', type: 'string', description: 'EXPENSEï¼ˆæ”¯å‡ºï¼‰ã¾ãŸã¯INCOMEï¼ˆåå…¥ï¼‰' },
        { name: 'description', type: 'string', description: 'å–å¼•ã®èª¬æ˜' },
        { name: 'date', type: 'date', description: 'å–å¼•æ—¥' },
        { name: 'categoryId', type: 'string', description: 'ã‚«ãƒ†ã‚´ãƒªID' },
        { name: 'userId', type: 'string', description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID' },
      ],
      relations: [
        { name: 'category', target: 'categories', type: 'many-to-one' },
      ],
    },
    {
      name: 'categories',
      description: 'æ”¯å‡ºãƒ»åå…¥ã®ã‚«ãƒ†ã‚´ãƒª',
      columns: [
        { name: 'id', type: 'string', description: 'ã‚«ãƒ†ã‚´ãƒªID' },
        { name: 'name', type: 'string', description: 'ã‚«ãƒ†ã‚´ãƒªåï¼ˆé£Ÿè²»ã€äº¤é€šè²»ãªã©ï¼‰' },
        { name: 'type', type: 'string', description: 'EXPENSEï¼ˆæ”¯å‡ºï¼‰ã¾ãŸã¯INCOMEï¼ˆåå…¥ï¼‰' },
        { name: 'icon', type: 'string', description: 'çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³' },
        { name: 'color', type: 'string', description: 'è¡¨ç¤ºè‰²ï¼ˆHEXï¼‰' },
      ],
    },
    {
      name: 'budgets',
      description: 'ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æœˆé–“äºˆç®—',
      columns: [
        { name: 'id', type: 'string', description: 'äºˆç®—ID' },
        { name: 'amount', type: 'decimal', description: 'äºˆç®—é¡ï¼ˆå††ï¼‰' },
        { name: 'month', type: 'date', description: 'å¯¾è±¡æœˆ' },
        { name: 'categoryId', type: 'string', description: 'ã‚«ãƒ†ã‚´ãƒªID' },
      ],
    },
  ],

  // AIã¸ã®ãƒ’ãƒ³ãƒˆ
  hints: [
    'é‡‘é¡ã¯æ—¥æœ¬å††ï¼ˆJPYï¼‰ã§è¡¨ç¤ºã—ã¦ãã ã•ã„',
    'ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®é›†è¨ˆã«ã¯ category.name ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„',
    'æœˆåˆ¥ã®é›†è¨ˆã«ã¯ date ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ month ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ãã ã•ã„',
    'æ”¯å‡ºã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã¯ type = "EXPENSE" ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ãã ã•ã„',
    'åå…¥ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã¯ type = "INCOME" ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ãã ã•ã„',
  ],
};
```

### Step 4: APIå®Ÿè£…

```typescript
// app/api/liquid/generate/route.ts

import { NextResponse } from 'next/server';
import { ProviderFactory } from '@liqueur/ai-provider';
import { SchemaValidator } from '@liqueur/protocol';
import { householdBudgetMetadata } from '@/lib/database-metadata';
import { getCurrentUser } from '@/lib/auth';

export async function POST(request: Request) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { prompt } = await request.json();

    // AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å–å¾—
    const provider = ProviderFactory.create();

    // ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ
    const schema = await provider.generateSchema({
      prompt,
      metadata: householdBudgetMetadata,
      context: {
        currentDate: new Date().toISOString(),
        userId: user.id,
      },
    });

    // ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
    const validator = new SchemaValidator();
    const result = validator.validate(schema);

    if (!result.valid) {
      return NextResponse.json(
        { error: 'Invalid schema', details: result.errors },
        { status: 400 }
      );
    }

    return NextResponse.json({ schema });
  } catch (error) {
    console.error('Generate error:', error);
    return NextResponse.json(
      { error: 'Generation failed' },
      { status: 500 }
    );
  }
}
```

### Step 5: DataSourceå®Ÿè¡Œ

```typescript
// lib/execute-datasource.ts

import { PrismaClient } from '@prisma/client';
import type { DataSource } from '@liqueur/protocol';

const prisma = new PrismaClient();

export async function executeDataSource(
  dataSource: DataSource,
  userId: string
): Promise<any[]> {
  const { resource, filters = [], aggregation, sort, limit } = dataSource;

  // Row-Level Security: å¿…ãšuserIdã§ãƒ•ã‚£ãƒ«ã‚¿
  const where: any = { userId };

  // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›
  for (const filter of filters) {
    where[filter.field] = convertOperator(filter.op, filter.value);
  }

  // ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
  if (aggregation) {
    return executeAggregation(resource, where, aggregation, sort, limit);
  }

  return prisma[resource].findMany({
    where,
    orderBy: sort ? { [sort.field]: sort.direction } : undefined,
    take: limit,
    include: getIncludes(resource),
  });
}

function convertOperator(op: string, value: any) {
  switch (op) {
    case 'eq': return value;
    case 'neq': return { not: value };
    case 'gt': return { gt: value };
    case 'gte': return { gte: value };
    case 'lt': return { lt: value };
    case 'lte': return { lte: value };
    case 'in': return { in: value };
    case 'contains': return { contains: value };
    default: return value;
  }
}

async function executeAggregation(
  resource: string,
  where: any,
  aggregation: any,
  sort: any,
  limit: number
) {
  const { type, field, by } = aggregation;

  const result = await prisma[resource].groupBy({
    by: [by],
    where,
    _sum: type === 'sum' ? { [field]: true } : undefined,
    _avg: type === 'avg' ? { [field]: true } : undefined,
    _count: type === 'count' ? { [field]: true } : undefined,
    _min: type === 'min' ? { [field]: true } : undefined,
    _max: type === 'max' ? { [field]: true } : undefined,
    orderBy: sort ? { [sort.field]: sort.direction } : undefined,
    take: limit,
  });

  // çµæœã‚’æ­£è¦åŒ–
  return result.map((row: any) => ({
    [by]: row[by],
    [`${field}_${type}`]: row[`_${type}`]?.[field] || row._count?.[field],
  }));
}

function getIncludes(resource: string) {
  if (resource === 'transactions') {
    return { category: true };
  }
  return undefined;
}
```

### Step 6: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

```tsx
// app/dashboard/page.tsx

'use client';

import { useState } from 'react';
import { LiquidRenderer } from '@liqueur/react';
import type { LiquidViewSchema } from '@liqueur/protocol';

export default function DashboardPage() {
  const [prompt, setPrompt] = useState('');
  const [schema, setSchema] = useState<LiquidViewSchema | null>(null);
  const [data, setData] = useState<Record<string, any[]>>({});
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleGenerate = async () => {
    setLoading(true);
    setError(null);

    try {
      // 1. ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ
      const genRes = await fetch('/api/liquid/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
      });

      if (!genRes.ok) {
        throw new Error('Schema generation failed');
      }

      const { schema: newSchema } = await genRes.json();
      setSchema(newSchema);

      // 2. ãƒ‡ãƒ¼ã‚¿å–å¾—
      const dataRes = await fetch('/api/liquid/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dataSources: newSchema.data_sources }),
      });

      if (!dataRes.ok) {
        throw new Error('Data fetch failed');
      }

      const { data: newData } = await dataRes.json();
      setData(newData);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">å®¶è¨ˆç°¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

      {/* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ› */}
      <div className="mb-6">
        <div className="flex gap-2">
          <input
            type="text"
            value={prompt}
            onChange={(e) => setPrompt(e.target.value)}
            placeholder="ä¾‹: ä»Šæœˆã®ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºã‚’å††ã‚°ãƒ©ãƒ•ã§è¡¨ç¤º"
            className="flex-1 p-2 border rounded"
          />
          <button
            onClick={handleGenerate}
            disabled={loading || !prompt}
            className="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
          >
            {loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆ'}
          </button>
        </div>

        {/* ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ */}
        <div className="mt-2 flex gap-2 flex-wrap">
          {[
            'ä»Šæœˆã®æ”¯å‡ºã‚’å††ã‚°ãƒ©ãƒ•ã§',
            'æœˆåˆ¥ã®æ”¯å‡ºæ¨ç§»ã‚’æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã§',
            'ä»Šæœˆã®æ”¯å‡ºæ˜ç´°ã‚’è¡¨ã§',
            'é£Ÿè²»ã¨äº¤é€šè²»ã‚’æ¯”è¼ƒ',
          ].map((sample) => (
            <button
              key={sample}
              onClick={() => setPrompt(sample)}
              className="text-sm px-2 py-1 bg-gray-100 rounded hover:bg-gray-200"
            >
              {sample}
            </button>
          ))}
        </div>
      </div>

      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
      {error && (
        <div className="mb-4 p-4 bg-red-100 text-red-700 rounded">
          {error}
        </div>
      )}

      {/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º */}
      {schema && (
        <LiquidRenderer
          schema={schema}
          data={data}
          loading={loading}
        />
      )}
    </div>
  );
}
```

---

## AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ

### ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

```typescript
// lib/system-prompt.ts

export const householdBudgetSystemPrompt = `
ã‚ãªãŸã¯å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”ŸæˆAIã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶è¨€èªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã€LiquidViewSchemaã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«

### transactionsï¼ˆå–å¼•ï¼‰
- amount: é‡‘é¡ï¼ˆå††ï¼‰
- type: EXPENSEï¼ˆæ”¯å‡ºï¼‰/ INCOMEï¼ˆåå…¥ï¼‰
- date: å–å¼•æ—¥
- categoryId: ã‚«ãƒ†ã‚´ãƒªID
- description: èª¬æ˜

### categoriesï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰
- name: ã‚«ãƒ†ã‚´ãƒªå
- type: EXPENSE / INCOME
- icon: çµµæ–‡å­—
- color: è‰²ã‚³ãƒ¼ãƒ‰

### budgetsï¼ˆäºˆç®—ï¼‰
- amount: äºˆç®—é¡
- month: å¯¾è±¡æœˆ
- categoryId: ã‚«ãƒ†ã‚´ãƒªID

## ãƒ«ãƒ¼ãƒ«

1. é‡‘é¡ã¯æ—¥æœ¬å††ã§è¡¨ç¤º
2. æ”¯å‡ºåˆ†æã®å ´åˆã¯ type="EXPENSE" ã§ãƒ•ã‚£ãƒ«ã‚¿
3. ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆã¯ category.name ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
4. æœˆåˆ¥é›†è¨ˆã¯ date ã‚’ month ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
5. ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—:
   - æ§‹æˆæ¯” â†’ pieï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
   - æ¨ç§» â†’ lineï¼ˆæŠ˜ã‚Œç·šï¼‰
   - æ¯”è¼ƒ â†’ barï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
   - ä¸€è¦§ â†’ tableï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

## å‡ºåŠ›å½¢å¼

LiquidViewSchemaï¼ˆJSONï¼‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
`;
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã¨æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

#### ä¾‹1: ã€Œä»Šæœˆã®ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºã‚’å††ã‚°ãƒ©ãƒ•ã§ã€

```json
{
  "version": "1.0",
  "layout": {
    "type": "grid",
    "columns": 1
  },
  "components": [
    {
      "type": "chart",
      "variant": "pie",
      "title": "ä»Šæœˆã®ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º",
      "data_source": "ds_category_expenses"
    }
  ],
  "data_sources": {
    "ds_category_expenses": {
      "resource": "transactions",
      "filters": [
        { "field": "type", "op": "eq", "value": "EXPENSE" },
        { "field": "date", "op": "gte", "value": "2026-01-01" },
        { "field": "date", "op": "lt", "value": "2026-02-01" }
      ],
      "aggregation": {
        "type": "sum",
        "field": "amount",
        "by": "category.name"
      }
    }
  }
}
```

#### ä¾‹2: ã€Œæœˆåˆ¥ã®æ”¯å‡ºæ¨ç§»ã‚’æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã§ã€

```json
{
  "version": "1.0",
  "layout": {
    "type": "grid",
    "columns": 1
  },
  "components": [
    {
      "type": "chart",
      "variant": "line",
      "title": "æœˆåˆ¥æ”¯å‡ºæ¨ç§»",
      "data_source": "ds_monthly_expenses",
      "x_axis": "month",
      "y_axis": "amount_sum"
    }
  ],
  "data_sources": {
    "ds_monthly_expenses": {
      "resource": "transactions",
      "filters": [
        { "field": "type", "op": "eq", "value": "EXPENSE" }
      ],
      "aggregation": {
        "type": "sum",
        "field": "amount",
        "by": "month"
      },
      "sort": {
        "field": "month",
        "direction": "asc"
      },
      "limit": 12
    }
  }
}
```

#### ä¾‹3: ã€Œä»Šæœˆã®æ”¯å‡ºæ˜ç´°ã‚’æ—¥ä»˜é †ã§è¡¨ç¤ºã€

```json
{
  "version": "1.0",
  "layout": {
    "type": "grid",
    "columns": 1
  },
  "components": [
    {
      "type": "table",
      "title": "ä»Šæœˆã®æ”¯å‡ºæ˜ç´°",
      "data_source": "ds_transactions",
      "columns": [
        { "field": "date", "header": "æ—¥ä»˜" },
        { "field": "category.name", "header": "ã‚«ãƒ†ã‚´ãƒª" },
        { "field": "description", "header": "å†…å®¹" },
        { "field": "amount", "header": "é‡‘é¡" }
      ]
    }
  ],
  "data_sources": {
    "ds_transactions": {
      "resource": "transactions",
      "filters": [
        { "field": "type", "op": "eq", "value": "EXPENSE" },
        { "field": "date", "op": "gte", "value": "2026-01-01" },
        { "field": "date", "op": "lt", "value": "2026-02-01" }
      ],
      "sort": {
        "field": "date",
        "direction": "desc"
      }
    }
  }
}
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 1. Row-Level Security

**ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã«userIdãƒ•ã‚£ãƒ«ã‚¿ã‚’å¼·åˆ¶**:

```typescript
// çµ¶å¯¾ã«ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„
async function executeDataSource(dataSource: DataSource, userId: string) {
  const where = { userId }; // å¿…ãšæœ€åˆã«è¨­å®š
  // ...
}
```

### 2. å…¥åŠ›æ¤œè¨¼

```typescript
// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
function sanitizePrompt(prompt: string): string {
  // æœ€å¤§é•·åˆ¶é™
  if (prompt.length > 500) {
    throw new Error('Prompt too long');
  }

  // å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
  const dangerousPatterns = [
    /DROP\s+TABLE/i,
    /DELETE\s+FROM/i,
    /<script>/i,
  ];

  for (const pattern of dangerousPatterns) {
    if (pattern.test(prompt)) {
      throw new Error('Invalid prompt');
    }
  }

  return prompt.trim();
}
```

### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```typescript
// 1åˆ†é–“ã«10ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
const rateLimiter = new RateLimiter({
  windowMs: 60 * 1000,
  max: 10,
});
```

### 4. èªè¨¼

```typescript
// JWTèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
import { JWTProvider } from '@liqueur/auth';

const jwtProvider = new JWTProvider({
  secret: process.env.JWT_SECRET!,
});

export async function getCurrentUser(request: Request) {
  const token = request.headers.get('Authorization')?.replace('Bearer ', '');
  if (!token) return null;

  try {
    return await jwtProvider.verify(token);
  } catch {
    return null;
  }
}
```

---

## ãƒ†ã‚¹ãƒˆ

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
// __tests__/execute-datasource.test.ts

import { executeDataSource } from '@/lib/execute-datasource';

describe('executeDataSource', () => {
  it('should always filter by userId', async () => {
    const dataSource = {
      resource: 'transactions',
      filters: [],
    };

    // åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
    const result = await executeDataSource(dataSource, 'user-1');

    for (const row of result) {
      expect(row.userId).toBe('user-1');
    }
  });

  it('should apply aggregation correctly', async () => {
    const dataSource = {
      resource: 'transactions',
      filters: [{ field: 'type', op: 'eq', value: 'EXPENSE' }],
      aggregation: { type: 'sum', field: 'amount', by: 'categoryId' },
    };

    const result = await executeDataSource(dataSource, 'user-1');

    expect(result).toBeInstanceOf(Array);
    expect(result[0]).toHaveProperty('amount_sum');
  });
});
```

### E2Eãƒ†ã‚¹ãƒˆ

```typescript
// e2e/dashboard.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Dashboard', () => {
  test.beforeEach(async ({ page }) => {
    // ãƒ­ã‚°ã‚¤ãƒ³
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
  });

  test('should generate pie chart from prompt', async ({ page }) => {
    await page.goto('/dashboard');

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›
    await page.fill('input[placeholder*="ä¾‹"]', 'ä»Šæœˆã®æ”¯å‡ºã‚’å††ã‚°ãƒ©ãƒ•ã§');
    await page.click('button:has-text("ç”Ÿæˆ")');

    // ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºã‚’å¾…æ©Ÿ
    await expect(page.locator('.recharts-pie')).toBeVisible({ timeout: 30000 });
  });

  test('should generate table from prompt', async ({ page }) => {
    await page.goto('/dashboard');

    await page.fill('input[placeholder*="ä¾‹"]', 'ä»Šæœˆã®æ”¯å‡ºæ˜ç´°ã‚’è¡¨ã§');
    await page.click('button:has-text("ç”Ÿæˆ")');

    await expect(page.locator('table')).toBeVisible({ timeout: 30000 });
  });
});
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤

### Vercelï¼ˆæ¨å¥¨ï¼‰

```bash
# 1. Vercel CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm i -g vercel

# 2. ãƒ‡ãƒ—ãƒ­ã‚¤
vercel

# 3. ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆVercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ï¼‰
# DATABASE_URL, AI_PROVIDER, DEEPSEEK_API_KEY, JWT_SECRET
```

### Docker

```dockerfile
# Dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npx prisma generate
RUN npm run build

EXPOSE 3000
CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/household_budget
      - AI_PROVIDER=deepseek
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=household_budget
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### é–‹ç™ºé–‹å§‹å‰
- [ ] Node.js 20+ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] PostgreSQLã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼APIã‚­ãƒ¼å–å¾—
- [ ] Liquidãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³

### å®Ÿè£…
- [ ] Prismaã‚¹ã‚­ãƒ¼ãƒä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- [ ] DatabaseMetadataå®šç¾©
- [ ] APIå®Ÿè£…ï¼ˆgenerate, executeï¼‰
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] RLSãƒ†ã‚¹ãƒˆï¼ˆä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ï¼‰

### ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
- [ ] å‹•ä½œç¢ºèª

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Project Liquid GitHub](https://github.com/clearclown/liqueur)
- [Liquid Philosophy](../philosophy/why-liquid.md)
- [Liquid Concepts](../tutorials/concepts.md)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Next.js Documentation](https://nextjs.org/docs)

---

## ã‚µãƒãƒ¼ãƒˆ

è³ªå•ã‚„å•é¡ŒãŒã‚ã‚Œã°ã€[GitHub Issues](https://github.com/clearclown/liqueur/issues)ã§å ±å‘Šã—ã¦ãã ã•ã„ã€‚
